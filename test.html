<!DOCTYPE html>
<html>
<head>
    <title>Pippi Voice - æ ¸å¿ƒè¨ºæ–·ä¸­å¿ƒ</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; background: #f4f7f6; }
        .test-card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .pass { color: #2ecc71; font-weight: bold; }
        .fail { color: #e74c3c; font-weight: bold; }
        .log { background: #2c3e50; color: #ecf0f1; padding: 10px; border-radius: 4px; font-size: 0.8rem; height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>ğŸˆ Pippi Voice æ ¸å¿ƒé©—è­‰ (v1.3.8)</h1>
    
    <div class="test-card">
        <h3>1. ç‹€æ…‹æ©Ÿè½‰ç§»é©—è­‰ (State Machine Test)</h3>
        <div id="fsm-test-result">åŸ·è¡Œä¸­...</div>
    </div>

    <div class="test-card">
        <h3>2. å¾©åŸé‚è¼¯é©—è­‰ (Undo Logic Test)</h3>
        <div id="undo-test-result">åŸ·è¡Œä¸­...</div>
    </div>

    <div class="test-card">
        <h3>3. é…ç½®å®Œæ•´æ€§æ¸¬è©¦ (Config Audit)</h3>
        <div id="config-test-result">åŸ·è¡Œä¸­...</div>
    </div>

    <h4>åŸ·è¡Œæ—¥èªŒï¼š</h4>
    <div id="debug-log" class="log"></div>

    <script type="module">
        import { StateMachine, AppState } from './src/state.js';
        import { VERSION } from './src/config.js';

        const logEl = document.getElementById('debug-log');
        function log(msg) { logEl.innerHTML += `> ${msg}<br>`; }

        function assertEqual(a, b, msg) {
            if (a !== b) throw new Error(`${msg} (é æœŸ "${b}"ï¼Œå¾—åˆ° "${a}")`);
        }

        // --- æ¸¬è©¦ 1: FSM ---
        try {
            log(`æ¸¬è©¦ v${VERSION} ç‹€æ…‹æ©Ÿ...`);
            let states = [];
            const fsm = new StateMachine((s) => states.push(s));
            fsm.transition(AppState.RECORDING);
            fsm.transition(AppState.FORMATTING);
            assertEqual(fsm.currentState, 'FORMATTING', 'ç‹€æ…‹æ©Ÿæ‡‰è™•æ–¼ FORMATTING');
            document.getElementById('fsm-test-result').innerHTML = '<span class="pass">âœ” é€šé</span>';
        } catch (e) {
            document.getElementById('fsm-test-result').innerHTML = `<span class="fail">âœ˜ å¤±æ•—: ${e.message}</span>`;
        }

        // --- æ¸¬è©¦ 2: Undo Logic ---
        try {
            log(`æ¸¬è©¦ Undo æ­·å²æ£§é‚è¼¯...`);
            let history = [];
            let currentText = "åˆå§‹æ–‡å­—";
            
            function push(txt) {
                if (history.length > 0 && history[history.length-1] === txt) return;
                history.push(currentText); // å­˜å…¥èˆŠæ–‡å­—
                currentText = txt; // æ›´æ–°ç‚ºæ–°æ–‡å­—
            }

            function undo() {
                if (history.length > 0) currentText = history.pop();
            }

            push("ç¬¬ä¸€æ¬¡ä¿®æ”¹");
            push("ç¬¬äºŒæ¬¡ä¿®æ”¹");
            undo();
            assertEqual(currentText, "ç¬¬ä¸€æ¬¡ä¿®æ”¹", "ç¬¬ä¸€æ¬¡ Undo æ‡‰å›åˆ°ç¬¬ä¸€æ¬¡ä¿®æ”¹");
            undo();
            assertEqual(currentText, "åˆå§‹æ–‡å­—", "ç¬¬äºŒæ¬¡ Undo æ‡‰å›åˆ°åˆå§‹æ–‡å­—");
            
            document.getElementById('undo-test-result').innerHTML = '<span class="pass">âœ” é€šéï¼šUndo æ£§æ¼”ç®—æ³•æ­£ç¢º</span>';
        } catch (e) {
            document.getElementById('undo-test-result').innerHTML = `<span class="fail">âœ˜ å¤±æ•—: ${e.message}</span>`;
        }

        // --- æ¸¬è©¦ 3: Config ---
        try {
            if (VERSION === '1.3.8') {
                document.getElementById('config-test-result').innerHTML = '<span class="pass">âœ” é€šéï¼šç‰ˆæœ¬è™Ÿå°é½Š</span>';
            } else {
                throw new Error(`ç‰ˆæœ¬è™Ÿä¸åŒ¹é…: ${VERSION}`);
            }
        } catch (e) {
            document.getElementById('config-test-result').innerHTML = `<span class="fail">âœ˜ å¤±æ•—: ${e.message}</span>`;
        }
    </script>
</body>
</html>
