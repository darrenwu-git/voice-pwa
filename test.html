<!DOCTYPE html>
<html>
<head>
    <title>Pippi Voice - æ ¸å¿ƒè¨ºæ–·ä¸­å¿ƒ v1.4.5</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; background: #f4f7f6; }
        .test-card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .pass { color: #2ecc71; font-weight: bold; }
        .fail { color: #e74c3c; font-weight: bold; }
        .log { background: #2c3e50; color: #ecf0f1; padding: 10px; border-radius: 4px; font-size: 0.8rem; height: 300px; overflow-y: auto; font-family: monospace; }
        h1 { margin-bottom: 5px; }
        .version { color: #666; font-size: 1rem; margin-bottom: 20px; }
    </style>
</head>
<body>
    <h1>ğŸˆ Pippi Voice æ ¸å¿ƒé‚è¼¯é©—è­‰</h1>
    <div class="version">ç‰ˆæœ¬: v1.4.5 (Stack Reliability Suite)</div>
    
    <div class="test-card">
        <h3>ğŸ§ª æ¸¬è©¦æ¡ˆä¾‹ 1: å…©éšæ®µå¾©åŸ (STT -> AI Format)</h3>
        <div id="case-1-result">åŸ·è¡Œä¸­...</div>
    </div>

    <div class="test-card">
        <h3>ğŸ§ª æ¸¬è©¦æ¡ˆä¾‹ 2: Redo æ¢å¾©åŠ›é©—è­‰</h3>
        <div id="case-2-result">åŸ·è¡Œä¸­...</div>
    </div>

    <h4>åŸ·è¡Œæ—¥èªŒï¼š</h4>
    <div id="debug-log" class="log"></div>

    <script type="module">
        import { VERSION } from './src/config.js';

        const logEl = document.getElementById('debug-log');
        function log(msg) { logEl.innerHTML += `> ${msg}<br>`; }
        function assertEqual(a, b, msg) {
            if (a !== b) throw new Error(`${msg} (é æœŸ: "${b}", å¾—åˆ°: "${a}")`);
        }

        // --- æ ¸å¿ƒ Undo/Redo å¼•æ“ ---
        class HistoryEngine {
            constructor(initial = "") {
                this.currentValue = initial;
                this.undoStack = [];
                this.redoStack = [];
            }
            save(newVal) {
                if (newVal === this.currentValue) return;
                this.undoStack.push(this.currentValue);
                this.currentValue = newVal;
                this.redoStack = [];
                log(`[Save] Current: "${this.currentValue}" (StackSize: ${this.undoStack.length})`);
            }
            undo() {
                if (this.undoStack.length > 0) {
                    this.redoStack.push(this.currentValue);
                    this.currentValue = this.undoStack.pop();
                    log(`[Undo] Back to: "${this.currentValue}"`);
                }
            }
            redo() {
                if (this.redoStack.length > 0) {
                    this.undoStack.push(this.currentValue);
                    this.currentValue = this.redoStack.pop();
                    log(`[Redo] Forward to: "${this.currentValue}"`);
                }
            }
        }

        // --- Case 1: Two-Stage Undo ---
        try {
            log("--- é–‹å§‹å…©éšæ®µå¾©åŸæ¸¬è©¦ ---");
            const engine = new HistoryEngine("åŸæœ¬å…§å®¹");
            engine.save("");
            engine.save("é€å­—ç¨¿å…§å®¹");
            engine.save("æ•´ç†å¾Œå…§å®¹");
            
            engine.undo();
            assertEqual(engine.currentValue, "é€å­—ç¨¿å…§å®¹", "ç¬¬ä¸€æ¬¡ Undo æ‡‰å›é€å­—ç¨¿");
            engine.undo();
            assertEqual(engine.currentValue, "", "ç¬¬äºŒæ¬¡ Undo æ‡‰å›ç©ºç™½");
            engine.undo();
            assertEqual(engine.currentValue, "åŸæœ¬å…§å®¹", "ç¬¬ä¸‰æ¬¡ Undo æ‡‰å›åŸæœ¬");
            
            document.getElementById('case-1-result').innerHTML = '<span class="pass">âœ” é€šéï¼šå¾©åŸéˆå®Œæ•´</span>';
        } catch (e) {
            document.getElementById('case-1-result').innerHTML = `<span class="fail">âœ˜ å¤±æ•—: ${e.message}</span>`;
        }

        // --- Case 2: Redo Recovery ---
        try {
            log("--- é–‹å§‹ Redo é©—è­‰ ---");
            const engine = new HistoryEngine("");
            engine.save("A");
            engine.save("B");
            engine.undo(); // back to A
            assertEqual(engine.currentValue, "A", "Undo failed");
            engine.redo(); // back to B
            assertEqual(engine.currentValue, "B", "Redo failed");
            document.getElementById('case-2-result').innerHTML = '<span class="pass">âœ” é€šéï¼šRedo é‚è¼¯æ­£ç¢º</span>';
        } catch (e) {
            document.getElementById('case-2-result').innerHTML = `<span class="fail">âœ˜ å¤±æ•—: ${e.message}</span>`;
        }
    </script>
</body>
</html>
