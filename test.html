<!DOCTYPE html>
<html>
<head>
    <title>Pippi Voice - æ ¸å¿ƒè¨ºæ–·ä¸­å¿ƒ v1.4.0</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; background: #f4f7f6; }
        .test-card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .pass { color: #2ecc71; font-weight: bold; }
        .fail { color: #e74c3c; font-weight: bold; }
        .log { background: #2c3e50; color: #ecf0f1; padding: 10px; border-radius: 4px; font-size: 0.8rem; height: 300px; overflow-y: auto; font-family: monospace; }
        h1 { margin-bottom: 5px; }
        .version { color: #666; font-size: 1rem; margin-bottom: 20px; }
    </style>
</head>
<body>
    <h1>ğŸˆ Pippi Voice æ ¸å¿ƒé‚è¼¯é©—è­‰</h1>
    <div class="version">ç‰ˆæœ¬: v1.4.0 (Undo/Redo Use Case Suite)</div>
    
    <div class="test-card">
        <h3>ğŸ§ª æ¸¬è©¦æ¡ˆä¾‹ 1: åŸºç¤ AI æ•´ç†å¾Œå¾©åŸ (Single Action)</h3>
        <div id="case-1-result">åŸ·è¡Œä¸­...</div>
    </div>

    <div class="test-card">
        <h3>ğŸ§ª æ¸¬è©¦æ¡ˆä¾‹ 2: é€£çºŒç·¨è¼¯èˆ‡åˆ†å‰ (Branching Logic)</h3>
        <div id="case-2-result">åŸ·è¡Œä¸­...</div>
    </div>

    <div class="test-card">
        <h3>ğŸ§ª æ¸¬è©¦æ¡ˆä¾‹ 3: éŒ„éŸ³è‡ªå‹•æ¸…ç©ºå¾Œçš„æ•‘å› (Auto-Clear Safety)</h3>
        <div id="case-3-result">åŸ·è¡Œä¸­...</div>
    </div>

    <h4>åŸ·è¡Œæ—¥èªŒï¼š</h4>
    <div id="debug-log" class="log"></div>

    <script type="module">
        import { VERSION } from './src/config.js';

        const logEl = document.getElementById('debug-log');
        function log(msg) { logEl.innerHTML += `> ${msg}<br>`; }
        function assertEqual(a, b, msg) {
            if (a !== b) throw new Error(`${msg} (é æœŸ: "${b}", å¾—åˆ°: "${a}")`);
        }

        // --- æ ¸å¿ƒ Undo/Redo æ¼”ç®—æ³•æ¨¡æ“¬ ---
        class HistoryEngine {
            constructor(initial) {
                this.current = initial;
                this.undoStack = [];
                this.redoStack = [];
            }
            save(newVal) {
                if (newVal === this.current) return;
                this.undoStack.push(this.current);
                this.current = newVal;
                this.redoStack = []; // æ¸…ç©ºé‡åšæ£§
                log(`Save: "${newVal}" (Undo Size: ${this.undoStack.length})`);
            }
            undo() {
                if (this.undoStack.length > 0) {
                    this.redoStack.push(this.current);
                    this.current = this.undoStack.pop();
                    log(`Undo to: "${this.current}"`);
                }
            }
            redo() {
                if (this.redoStack.length > 0) {
                    this.undoStack.push(this.current);
                    this.current = this.redoStack.pop();
                    log(`Redo to: "${this.current}"`);
                }
            }
        }

        // --- Case 1: AI Format ---
        try {
            log("--- åŸ·è¡Œ Case 1 ---");
            const engine = new HistoryEngine("åŸå§‹æ–‡å­—");
            engine.save("AI æ•´ç†å¾Œçš„æ¼‚äº®æ–‡å­—");
            engine.undo();
            assertEqual(engine.current, "åŸå§‹æ–‡å­—", "Undo æ‡‰å›åˆ°åŸå§‹æ–‡å­—");
            engine.redo();
            assertEqual(engine.current, "AI æ•´ç†å¾Œçš„æ¼‚äº®æ–‡å­—", "Redo æ‡‰å›åˆ°æ•´ç†å¾Œæ–‡å­—");
            document.getElementById('case-1-result').innerHTML = '<span class="pass">âœ” é€šé</span>';
        } catch (e) {
            document.getElementById('case-1-result').innerHTML = `<span class="fail">âœ˜ å¤±æ•—: ${e.message}</span>`;
        }

        // --- Case 2: Branching ---
        try {
            log("--- åŸ·è¡Œ Case 2 ---");
            const engine = new HistoryEngine("A");
            engine.save("B");
            engine.save("C");
            engine.undo(); // å›åˆ° B
            assertEqual(engine.current, "B", "Undo 1 æ¬¡æ‡‰ç‚º B");
            engine.save("D"); // åœ¨ B çš„åŸºç¤ä¸Šæ–°ä¿®æ”¹ Dï¼Œæ‡‰æ¸…ç©º C çš„ Redo
            assertEqual(engine.redoStack.length, 0, "æ–°ä¿®æ”¹å¾Œ Redo æ‡‰æ¸…ç©º");
            engine.undo();
            assertEqual(engine.current, "B", "Undo æ‡‰å›åˆ° B");
            engine.undo();
            assertEqual(engine.current, "A", "Undo æ‡‰å›åˆ° A");
            document.getElementById('case-2-result').innerHTML = '<span class="pass">âœ” é€šé</span>';
        } catch (e) {
            document.getElementById('case-2-result').innerHTML = `<span class="fail">âœ˜ å¤±æ•—: ${e.message}</span>`;
        }

        // --- Case 3: Auto-Clear ---
        try {
            log("--- åŸ·è¡Œ Case 3 ---");
            const engine = new HistoryEngine("èˆŠå°è©±å…§å®¹");
            // æ¨¡æ“¬é–‹å§‹éŒ„éŸ³
            engine.save(""); 
            assertEqual(engine.current, "", "ç›®å‰æ‡‰ç‚ºæ¸…ç©ºç‹€æ…‹");
            engine.undo();
            assertEqual(engine.current, "èˆŠå°è©±å…§å®¹", "Undo æ‡‰æ•‘å›éŒ„éŸ³å‰è¢«æ¸…ç©ºçš„å…§å®¹");
            document.getElementById('case-3-result').innerHTML = '<span class="pass">âœ” é€šé</span>';
        } catch (e) {
            document.getElementById('case-3-result').innerHTML = `<span class="fail">âœ˜ å¤±æ•—: ${e.message}</span>`;
        }
    </script>
</body>
</html>
